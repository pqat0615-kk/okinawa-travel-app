<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸŒŠ æ²–ç¹©è¼•æ—…è¡Œ - æ—¥ç³»æ¥µç°¡è¡Œç¨‹è¦åŠƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vuedraggable/4.1.0/vuedraggable.umd.min.js"></script>

    <style>
        /* ğŸ¨ æ—¥ç³»æ¥µç°¡å¯æ„›é¢¨ / æ²–ç¹©æµ·æ´‹é¢¨æ ¼é…è‰²å®šç¾© */
        :root {
            --primary-blue: #66CCFF; /* ä¸»è‰²ï¼šæµ·æ´‹è— */
            --light-blue: #E0F7FF; /* ç¶²é èƒŒæ™¯å»¶ä¼¸è‰² (æ¥µæ·ºè—) */
            --trip-date-bg: #40A4E0; /* è¼ƒæ·±çš„è—ï¼Œç”¨æ–¼æ—¥æœŸé¸ä¸­ */
            
            /* ICON é¡è‰²å·®ç•°åŒ– */
            --icon-itinerary: #40A4E0; 
            --icon-info: #FF88AA; 
            --icon-shopping: #77DD77; 
            --icon-expenses: #FFCC66; 
        }
        
        body {
            background-color: var(--light-blue);
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header-banner {
            height: 250px; 
            position: relative;
        }

        .header-arc {
            position: absolute;
            bottom: -50px; 
            left: 0;
            right: 0;
            height: 100px;
            background-color: white; 
            border-top-left-radius: 50%; 
            border-top-right-radius: 50%;
            transform: scaleX(1.5); 
            z-index: 10;
        }

        .tab-nav {
             position: absolute;
             bottom: 0;
             right: 0;
             z-index: 30; 
             padding: 1rem;
             display: flex;
             gap: 0.5rem;
             transform: translateY(-50%); 
        }
        
        .main-content {
            margin-top: -50px; 
            position: relative;
            z-index: 20;
            background-color: white; 
            padding-top: 20px; 
            min-height: calc(100vh - 200px); 
        }

        .date-scroll-container {
            overflow-x: auto;
            white-space: nowrap;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .date-scroll-container::-webkit-scrollbar {
            display: none;
        }
        
        .category-tag {
            font-size: 0.75rem; 
            padding: 0.1rem 0.5rem;
            border-radius: 9999px; 
            font-weight: 600; 
            margin-bottom: 0.5rem;
            display: inline-block;
        }
        .page-content-wrapper {
            padding-bottom: 80px; 
        }
    </style>
</head>

<body>
    <div id="app" class="max-w-md mx-auto shadow-2xl bg-white min-h-screen">
        
        <header class="header-banner overflow-hidden relative">
            <img src="okinawa_photo1.png" alt="æ²–ç¹©æµ·æ´‹é¢¨æ™¯" class="w-full h-full object-cover">
            <div class="header-arc"></div>

            <nav class="tab-nav">
                <button @click="activeTab = 'itinerary'" class="p-3 bg-white rounded-full shadow-lg transition duration-300" :class="{'text-[var(--icon-itinerary)] scale-110 shadow-xl': activeTab === 'itinerary', 'text-gray-400': activeTab !== 'itinerary'}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>
                <button @click="activeTab = 'info'" class="p-3 bg-white rounded-full shadow-lg transition duration-300" :class="{'text-[var(--icon-info)] scale-110 shadow-xl': activeTab === 'info', 'text-gray-400': activeTab !== 'info'}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </button>
                <button @click="activeTab = 'shopping'" class="p-3 bg-white rounded-full shadow-lg transition duration-300" :class="{'text-[var(--icon-shopping)] scale-110 shadow-xl': activeTab === 'shopping', 'text-gray-400': activeTab !== 'shopping'}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                </button>
                <button @click="activeTab = 'expenses'" class="p-3 bg-white rounded-full shadow-lg transition duration-300" :class="{'text-[var(--icon-expenses)] scale-110 shadow-xl': activeTab === 'expenses', 'text-gray-400': activeTab !== 'expenses'}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 10v-1m-7-5h10M4 4h16a1 1 0 011 1v14a1 1 0 01-1 1H4a1 1 0 01-1-1V5a1 1 0 011-1z"/></svg>
                </button>
            </nav>
        </header>

        <main class="main-content p-4 relative">
            <div class="page-content-wrapper">
                
                <div v-show="activeTab === 'itinerary'">
                    <h2 class="text-2xl font-extrabold text-[var(--icon-itinerary)] mb-4">ğŸ—“ï¸ æ¯æ—¥è¡Œç¨‹</h2>

                    <div class="date-scroll-container pb-4 mb-4 border-b">
                        <div class="flex space-x-3">
                            <div v-for="day in days" :key="day.date" @click="selectedDate = day.date" 
                                class="flex-shrink-0 text-center p-3 rounded-xl cursor-pointer transition duration-300 shadow-md" 
                                :class="{'bg-[var(--trip-date-bg)] text-white scale-105': selectedDate === day.date, 'bg-gray-100 text-gray-500 hover:bg-gray-200': selectedDate !== day.date}">
                                <div class="text-lg font-bold">{{ day.dayOfWeek }}</div>
                                <div class="text-xs">{{ day.dateNumber }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="weather" class="bg-blue-50 border-l-4 border-[var(--icon-itinerary)] p-4 mb-4 rounded-lg flex justify-between items-center shadow-inner">
                        <div class="flex items-center space-x-3">
                            <span class="text-3xl">{{ weather.icon }}</span> 
                            <span class="text-xl font-semibold text-gray-800">{{ weather.temperature }}Â°C</span>
                        </div>
                        <div>
                            <div class="text-sm text-gray-600">é«”æ„Ÿï¼š{{ weather.feelsLike }}Â°C</div>
                            <div class="text-xs text-gray-400">æ²–ç¹© é‚£éœ¸ (è‡ªå‹•æŠ“å–)</div>
                        </div>
                    </div>

                    <draggable v-model="filteredItinerary" item-key="id" tag="div" class="space-y-4">
                        <template #item="{ element: item, index }">
                            <div :class="{'opacity-50': item.type === 'flight'}" class="bg-white p-4 rounded-xl shadow-md border-l-4 border-gray-200 transition duration-300 hover:shadow-lg cursor-grab">
                                
                                <div v-if="item.transportation" class="flex items-center text-sm text-[var(--primary-blue)] mb-2">
                                    <span class="mr-1">{{ transportationIcon(item.transportation) }}</span> 
                                    <span>{{ item.travelTime }} ({{ item.transportation }})</span>
                                </div>

                                <div v-if="item.type === 'flight'" class="bg-[var(--light-blue)] p-3 rounded-lg border border-[var(--icon-itinerary)]">
                                    <p class="font-bold text-lg text-[var(--trip-date-bg)] mb-1">âœˆï¸ {{ item.name }} ({{ item.flightNumber }})</p>
                                    <p class="text-sm text-gray-600">ç‹€æ…‹ï¼š{{ flightInfo.status }}</p>
                                    <div class="flex justify-between text-sm mt-1">
                                        <span>{{ item.departureAirport }} {{ item.departureTime }}</span>
                                        <span class="font-semibold text-gray-500">â†’</span>
                                        <span>{{ item.arrivalAirport }} {{ item.arrivalTime }}</span>
                                    </div>
                                </div>

                                <div v-else class="flex justify-between items-start">
                                    <span class="category-tag text-white" :style="{ backgroundColor: getCategoryColor(item.type) }">
                                        {{ getCategoryLabel(item.type) }}
                                    </span>
                                    <div @click="openGoogleMaps(item.name)" class="flex-grow cursor-pointer active:opacity-75">
                                        <p class="text-lg font-bold text-gray-800">{{ item.name }}</p>
                                        <p v-if="item.openingHours" class="text-sm text-gray-600">ğŸ•˜ æ™‚é–“ï¼š{{ item.openingHours }}</p>
                                        <p v-if="item.ticket" class="text-sm text-red-500">ğŸŸï¸ è²»ç”¨/é–€ç¥¨ï¼š{{ item.ticket }}</p>
                                        <p v-if="item.notes" class="text-sm text-gray-500 mt-1">ğŸ“ å‚™è¨»ï¼š{{ item.notes }}</p>
                                    </div>
                                    <button @click="editItem(item)" class="text-gray-400 hover:text-[var(--icon-itinerary)] ml-4 flex-shrink-0 p-1 rounded-full hover:bg-gray-100">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-1.414 7.07l.707.707-2.828 2.828-.707-.707 2.828-2.828zM10 5a5 5 0 0110 0v10a5 5 0 01-10 0V5z" clip-rule="evenodd"/></svg>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </draggable>
                    
                    <div v-if="filteredItinerary.length === 0" class="text-center p-8 bg-gray-50 rounded-xl shadow-inner text-gray-500">
                        <p class="text-lg font-semibold">ç•¶æ—¥å°šæœªè¦åŠƒè¡Œç¨‹ ğŸ¤”</p>
                        <p class="text-sm mt-2">è«‹é»æ“Šå³ä¸‹è§’æŒ‰éˆ•æ–°å¢é …ç›®</p>
                    </div>

                    <button @click="openAddModal('itinerary', 'add')" class="fixed bottom-4 right-4 p-4 bg-[var(--icon-itinerary)] text-white rounded-full shadow-xl hover:bg-blue-400 transition duration-300 z-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    </button>
                </div>

                <div v-show="activeTab === 'info'">
                    <h2 class="text-2xl font-extrabold text-[var(--icon-info)] mb-6">â„¹ï¸ æ—…éŠè³‡è¨Š</h2>
                    
                    <div class="bg-red-50 p-4 rounded-xl mb-6 border border-[var(--icon-info)] shadow-md">
                        <h3 class="font-bold text-xl text-gray-700 mb-3">ğŸ’µ åŒ¯ç‡æ›ç®— (JPY â†’ TWD)</h3>
                        <div class="flex items-center space-x-2">
                            <input type="number" v-model.number="jpyAmount" placeholder="è¼¸å…¥æ—¥å¹£é‡‘é¡" class="w-1/2 p-2 border rounded-lg focus:ring-[var(--icon-info)] focus:border-[var(--icon-info)] text-lg">
                            <span class="text-xl font-semibold">JPY</span>
                        </div>
                        <div class="mt-3 text-3xl font-bold text-green-600">
                            = {{ twdAmount.toFixed(2) }} TWD
                        </div>
                        <p class="text-xs text-gray-400 mt-2">ï¼ˆä»¥ç•¶æ—¥åŒ¯ç‡ {{ exchangeRate }} è¨ˆç®—ï¼‰</p>
                    </div>

                    <div class="mb-6">
                        <h3 class="font-bold text-xl text-gray-700 mb-3">âœˆï¸ èˆªç­è³‡è¨Š (å‹•æ…‹æ¨¡æ“¬)</h3>
                        <div class="bg-gray-50 p-4 rounded-xl shadow-sm mb-3 border border-gray-200">
                            <p class="font-bold text-[var(--trip-date-bg)] mb-1">å»ç¨‹: {{ flightInfo.outbound.date }} ({{ flightInfo.status }})</p>
                            <p class="text-sm font-semibold">{{ flightInfo.outbound.flightNumber }}: {{ flightInfo.outbound.departureAirport }} {{ flightInfo.outbound.departureTime }} â†’ {{ flightInfo.outbound.arrivalAirport }} {{ flightInfo.outbound.arrivalTime }}</p>
                            <p class="text-xs text-gray-500">é£›è¡Œæ™‚é–“: {{ flightInfo.outbound.duration }}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-xl shadow-sm border border-gray-200">
                            <p class="font-bold text-[var(--trip-date-bg)] mb-1">å›ç¨‹: {{ flightInfo.return.date }} ({{ flightInfo.status }})</p>
                            <p class="text-sm font-semibold">{{ flightInfo.return.flightNumber }}: {{ flightInfo.return.departureAirport }} {{ flightInfo.return.departureTime }} â†’ {{ flightInfo.return.arrivalAirport }} {{ flightInfo.return.arrivalTime }}</p>
                            <p class="text-xs text-gray-500">é£›è¡Œæ™‚é–“: {{ flightInfo.return.duration }}</p>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-bold text-xl text-gray-700 mb-3">ğŸ¨ ä½å®¿è³‡è¨Š</h3>
                        <div class="bg-gray-50 p-4 rounded-xl shadow-sm border border-gray-200">
                            <p class="font-bold text-[var(--icon-info)] text-lg">{{ accommodation.name }}</p>
                            <p class="text-sm text-gray-700 mt-1">ğŸ“ é›»è©±: {{ accommodation.phone }}</p>
                            <p class="text-sm text-gray-700">ğŸ“ åœ°å€: {{ accommodation.address }}</p>
                            <a href="#" @click.prevent="openGoogleMaps(accommodation.name)" class="inline-flex items-center text-sm text-red-500 mt-2 hover:underline font-semibold">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/></svg>
                                é–‹å•Ÿå°èˆª
                            </a>
                        </div>
                    </div>
                </div>

                <div v-show="activeTab === 'shopping'">
                    <h2 class="text-2xl font-extrabold text-[var(--icon-shopping)] mb-4">ğŸ›’ è³¼ç‰©æ¸…å–®</h2>

                    <div class="space-y-3">
                        <div v-for="item in shoppingList" :key="item.id" class="flex items-center bg-gray-50 p-3 rounded-lg shadow-sm border border-gray-200">
                            <div class="w-12 h-12 bg-gray-200 rounded-lg mr-3 overflow-hidden flex items-center justify-center text-gray-400 text-xs">
                                <span v-if="!item.image">ğŸ“·</span>
                                <img v-else :src="item.image" alt="å•†å“åœ–ç‰‡" class="w-full h-full object-cover">
                            </div>
                            <div class="flex-grow">
                                <p class="font-semibold text-gray-800">{{ item.name }}</p>
                            </div>
                            <button @click="deleteItem(item.id, 'shopping')" class="text-red-400 hover:text-red-600 p-1 rounded-full hover:bg-red-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                    </div>

                    <button @click="openAddModal('shopping', 'add')" class="fixed bottom-4 right-4 p-4 bg-[var(--icon-shopping)] text-white rounded-full shadow-xl hover:bg-green-400 transition duration-300 z-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    </button>
                </div>

                <div v-show="activeTab === 'expenses'">
                    <h2 class="text-2xl font-extrabold text-[var(--icon-expenses)] mb-4">ğŸ’° èŠ±è²»ç´€éŒ„</h2>

                    <div class="bg-red-50 p-4 rounded-xl mb-6 border border-red-400 text-center shadow-md">
                        <p class="text-sm font-semibold text-gray-600">ç¸½èŠ±è²» (TWD)</p>
                        <p class="text-3xl font-bold text-red-600">{{ totalTWDExpenses.toLocaleString() }} TWD</p>
                        <p class="text-sm text-gray-500 mt-1">ï¼ˆæ—¥å¹£é‡‘é¡ç´„ {{ (totalTWDExpenses / exchangeRate).toFixed(0).toLocaleString() }} JPYï¼‰</p>
                    </div>

                    <div class="space-y-3">
                        <div v-for="expense in expenses" :key="expense.id" class="bg-gray-50 p-3 rounded-lg shadow-sm flex justify-between items-center border border-gray-200">
                            <div>
                                <p class="font-semibold text-gray-800">{{ expense.name }}</p>
                                <p class="text-xs text-gray-500">{{ expense.date }} | {{ expense.category }} ({{ expense.payment }})</p>
                                <p v-if="expense.notes" class="text-xs text-gray-400">å‚™è¨»: {{ expense.notes }}</p>
                            </div>
                            <p class="font-bold text-lg text-red-500">{{ expense.amount.toLocaleString() }} TWD</p>
                        </div>
                    </div>

                    <button @click="openAddModal('expenses', 'add')" class="fixed bottom-4 right-4 p-4 bg-[var(--icon-expenses)] text-white rounded-full shadow-xl hover:bg-yellow-400 transition duration-300 z-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 10v-1m-7-5h10M4 4h16a1 1 0 011 1v14a1 1 0 01-1 1H4a1 1 0 01-1-1V5a1 1 0 011-1z"/></svg>
                    </button>
                </div>
            </div> <div v-if="isModalOpen" @click.self="isModalOpen = false" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                    <h3 class="text-xl font-bold text-[var(--primary-blue)] mb-4">
                        {{ modalTitle }}
                    </h3>
                    <p class="text-gray-600 mb-4 text-sm">æ­¤è™•ç‚ºæ¨¡æ…‹è¦–çª—å…§å®¹ï¼Œéœ€è¦å¯¦ä½œæ ¹æ“š **{{ modalContext }}** çš„è¡¨å–®è¼¸å…¥é‚è¼¯ã€‚</p>
                    
                    <button v-if="modalMode === 'edit'" @click="confirmDelete" class="w-full p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition duration-150 mb-2 font-semibold">
                        ğŸ—‘ï¸ åˆªé™¤ (éœ€ç¢ºèª)
                    </button>

                    <button @click="isModalOpen = false" class="w-full p-2 bg-gray-200 rounded-lg hover:bg-gray-300">é—œé–‰</button>
                </div>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, computed } = Vue

        const Draggable = window.vuedraggable;
        
        const CATEGORY_MAP = {
            sightseeing: { label: 'æ™¯é»', color: '#40A4E0' }, 
            accommodation: { label: 'ä½å®¿', color: '#8A2BE2' }, 
            food: { label: 'ç¾é£Ÿ', color: '#F7A072' }, 
            shopping: { label: 'è³¼ç‰©', color: '#77DD77' }, 
            flight: { label: 'èˆªç­', color: '#CCB0E0' }, 
            other: { label: 'å…¶ä»–', color: '#B0B0B0' }, 
        };

        createApp({
            components: { Draggable },
            setup() {
                const activeTab = ref('itinerary');

                const exchangeRate = 0.2210; 
                const jpyAmount = ref(0);
                const twdAmount = computed(() => jpyAmount.value * exchangeRate);

                const flightInfo = ref({
                    status: 'æº–é»', 
                    outbound: { date: '2026/01/03', departureAirport: 'KHH', arrivalAirport: 'OKA', flightNumber: 'IT288', departureTime: '9:45', arrivalTime: '12:30', duration: '1å°æ™‚45åˆ†' },
                    return: { date: '2026/01/06', departureAirport: 'OKA', arrivalAirport: 'KHH', flightNumber: 'SL391', departureTime: '11:50', arrivalTime: '12:40', duration: '0å°æ™‚50åˆ†' },
                });
                
                const accommodation = ref({
                    name: 'Okinawa NaHaNa hotel&Spa',
                    phone: '+81-98-866-5151',
                    address: '2-3-1 Matsuo, Naha, Okinawa 900-0014 Japan',
                });
                
                const weather = ref({
                    icon: 'â˜€ï¸', 
                    temperature: 20, 
                    feelsLike: 22, 
                });

                // *** æ ¸å¿ƒè¡Œç¨‹æ•¸æ“šï¼šé€™æ˜¯æ‚¨æä¾›çš„å®Œæ•´è¡Œç¨‹ ***
                const itinerary = ref([
                    // Day 1: 2026-01-03
                    { id: 1, day: 'Day1', date: '2026-01-03', type: 'flight', name: 'èˆªç­è³‡è¨Š (KHHâ†’OKA)', flightNumber: 'IT288', departureTime: '9:45', arrivalTime: '12:30', departureAirport: 'KHH', arrivalAirport: 'OKA', travelTime: null, transportation: null, notes: 'è«‹å‹™å¿…æå‰å ±åˆ°ï¼Œé è¨ˆ12:30æŠµé”' },
                    { id: 2, day: 'Day1', date: '2026-01-03', type: 'other', name: 'æ©Ÿå ´å¯„è¡Œæ', openingHours: 'ç´„ 13:00', ticket: null, notes: 'é‚£éœ¸æ©Ÿå ´2F, ã‚†ã„ã«ã¡ã‚¹ãƒˆãƒªãƒ¼ãƒˆ (Before U Go)', travelTime: '30åˆ†', transportation: 'æ­¥è¡Œ' },
                    { id: 3, day: 'Day1', date: '2026-01-03', type: 'sightseeing', name: 'iias (DMMæ°´æ—é¤¨) / é¤µè²“é ­é·¹', openingHours: '10:00-21:00', ticket: 'æ°´æ—é¤¨ 2400 JPY', notes: 'æ­TK01/TK02 (13:32, 14:02) å¯é¸', travelTime: '30åˆ†', transportation: 'å¤§çœ¾é‹è¼¸' },
                    { id: 4, day: 'Day1', date: '2026-01-03', type: 'food', name: 'ç€¨é•·å³¶ å¹¸ç¦é¬†é¤…', openingHours: '10:00-19:30', ticket: null, notes: 'æ­TK01/TK02å‰å¾€ï¼Œå…ˆæ‹¿è™Ÿç¢¼ç‰Œ', travelTime: '20åˆ†', transportation: 'å¤§çœ¾é‹è¼¸' },
                    { id: 5, day: 'Day1', date: '2026-01-03', type: 'food', name: 'æ²–ç¹©è¦è¦é£¯', openingHours: '11:00-21:00', ticket: null, notes: 'ç€¨é•·å³¶ä¸Šï¼Œæ­¥è¡Œå¯é”ï¼Œå¯å’Œé¬†é¤…ä¸€èµ·è§£æ±º', travelTime: '10åˆ†', transportation: 'æ­¥è¡Œ' },
                    { id: 6, day: 'Day1', date: '2026-01-03', type: 'food', name: 'åœ‹éš›é€šæ™šé¤: yakiniku horumon nakama', openingHours: '17:00-23:00', ticket: null, notes: 'æ­TK01/TK02å›é‚£éœ¸å¸‚å€åœ‹éš›é€š', travelTime: '40åˆ†', transportation: 'å¤§çœ¾é‹è¼¸' },
                    
                    // Day 2: 2026-01-04
                    { id: 7, day: 'Day2', date: '2026-01-04', type: 'other', name: 'è³é¯¨è¡Œç¨‹é£¯åº—é›†åˆ', openingHours: '7:30', ticket: null, notes: 'è³é¯¨èˆ¹æ¥­è€…æ–¼é£¯åº—é›†åˆ', travelTime: '15åˆ†', transportation: 'æ­¥è¡Œ' }, 
                    { id: 8, day: 'Day2', date: '2026-01-04', type: 'sightseeing', name: 'è³é¯¨èˆ¹', openingHours: '8:00å‡ºç™¼', ticket: 'ç´„ 6000 JPY', notes: 'é è¨ˆ 13:00 çµæŸä¸¦é€å›é£¯åº—/ç¸£å»³', travelTime: '5åˆ†', transportation: 'é–‹è»Š' },
                    { id: 9, day: 'Day2', date: '2026-01-04', type: 'food', name: 'ç¾åœ‹æ‘æ™šé¤: steak88', openingHours: '11:00-22:00', ticket: null, notes: 'å¾ç¸£å»³æ­è»Šå‰å¾€ç¾åœ‹æ‘', travelTime: '45åˆ†', transportation: 'å¤§çœ¾é‹è¼¸' },
                    
                    // Day 3: 2026-01-05
                    { id: 10, day: 'Day3', date: '2026-01-05', type: 'sightseeing', name: 'æ³¢ä¸Šå®®', openingHours: '9:00', ticket: null, notes: '9é»é–‹å§‹è²©è³£å¾¡å®ˆï¼Œé è¨ˆ11:00é›¢é–‹', travelTime: '15åˆ†', transportation: 'æ­¥è¡Œ' },
                    { id: 11, day: 'Day3', date: '2026-01-05', type: 'food', name: 'æ•˜æ•˜è‹‘ (æ­Œç”ºç«™)', openingHours: '12:15', ticket: null, notes: 'æ­¥è¡Œè‡³è¼•è»Œæ­åˆ°æ­Œç”ºç«™ï¼Œåˆé¤é ç´„æ™‚é–“ 12:15', travelTime: '30åˆ†', transportation: 'å¤§çœ¾é‹è¼¸' },
                    { id: 12, day: 'Day3', date: '2026-01-05', type: 'shopping', name: 'Parco city', openingHours: '10:00-22:00', ticket: null, notes: 'ä¸‹åˆè³¼ç‰©è¡Œç¨‹ A', travelTime: '15åˆ†', transportation: 'é–‹è»Š' },
                    { id: 13, day: 'Day3', date: '2026-01-05', type: 'shopping', name: 'Aeon mall', openingHours: '10:00-22:00', ticket: null, notes: 'ä¸‹åˆè³¼ç‰©è¡Œç¨‹ B (äºŒé¸ä¸€)', travelTime: '10åˆ†', transportation: 'é–‹è»Š' },
                    
                    // Day 4: 2026-01-06
                    { id: 14, day: 'Day4', date: '2026-01-06', type: 'other', name: 'é›¢é–‹é£¯åº—å‰å¾€æ©Ÿå ´', openingHours: '9:00', ticket: null, notes: 'å»ºè­°9:00å‰æ•´ç†å®Œç•¢é€€æˆ¿', travelTime: '30åˆ†', transportation: 'å¤§çœ¾é‹è¼¸' },
                    { id: 15, day: 'Day4', date: '2026-01-06', type: 'flight', name: 'èˆªç­è³‡è¨Š (OKAâ†’KHH)', flightNumber: 'SL391', departureTime: '11:50', arrivalTime: '12:40', departureAirport: 'OKA', arrivalAirport: 'KHH', travelTime: null, transportation: null, notes: 'å»ºè­° 9:30 å‰æŠµé”æ©Ÿå ´' },
                ]);

                // *** æ ¸å¿ƒä¿®æ­£ï¼šç¢ºä¿ selectedDate é è¨­å€¼ç‚ºè¡Œç¨‹è¡¨ä¸­çš„ç¬¬ä¸€å€‹æ—¥æœŸ ***
                // 1. æŠ“å–æ‰€æœ‰ä¸é‡è¤‡çš„æ—¥æœŸä¸¦æ’åº
                const uniqueDates = [...new Set(itinerary.value.map(item => item.date))].sort();
                // 2. ä½¿ç”¨ç¬¬ä¸€å€‹æ—¥æœŸä½œç‚ºé è¨­å€¼
                const initialDate = uniqueDates.length > 0 ? uniqueDates[0] : '2026-01-03';
                const selectedDate = ref(initialDate);

                const shoppingList = ref([
                    { id: 1, name: 'ç´…èŠ‹è›‹å¡”', image: null },
                    { id: 2, name: 'é›ªé¹½é‡‘æ¥šç³•', image: null },
                ]);

                const expenses = ref([
                    { id: 1, category: 'æ©Ÿç¥¨', name: 'æ©Ÿç¥¨è²»ç”¨ (å¾€è¿”)', date: '2026-01-03', amount: 27448, payment: 'ä¿¡ç”¨å¡', notes: 'å°å¹£é‡‘é¡' },
                    { id: 2, category: 'ä½å®¿', name: 'é£¯åº—è²»ç”¨ (3æ™š)', date: '2026-01-03', amount: 10173, payment: 'ä¿¡ç”¨å¡', notes: 'å°å¹£é‡‘é¡' },
                    { id: 3, category: 'é–€ç¥¨', name: 'DMM æ°´æ—é¤¨é–€ç¥¨', date: '2026-01-03', amount: 580, payment: 'ç¾é‡‘', notes: 'å°å¹£é‡‘é¡' },
                ]);

                const isModalOpen = ref(false);
                const modalContext = ref(''); 
                const modalMode = ref('add'); 

                // --- Computed å±¬æ€§ ---
                
                const days = computed(() => {
                    const dateMap = {};
                    itinerary.value.forEach(item => {
                        if (!dateMap[item.date]) {
                            const dateObj = new Date(item.date);
                            dateMap[item.date] = {
                                date: item.date,
                                // å°‡ day æ¬„ä½å¾ 'Day1' è½‰æ›ç‚º 'é€±å…­' ç­‰æ ¼å¼
                                dayOfWeek: item.day.replace('Day1', 'é€±å…­').replace('Day2', 'é€±æ—¥').replace('Day3', 'é€±ä¸€').replace('Day4', 'é€±äºŒ'), 
                                dateNumber: dateObj.getDate(), 
                            };
                        }
                    });
                    // ç¢ºä¿æ—¥æœŸæŒ‰æ™‚é–“é †åºæ’åˆ—
                    return Object.values(dateMap).sort((a, b) => new Date(a.date) - new Date(b.date));
                });
                
                const filteredItinerary = computed({
                    get() {
                        // ç¯©é¸å‡ºé¸ä¸­æ—¥æœŸçš„æ‰€æœ‰è¡Œç¨‹
                        return itinerary.value.filter(item => item.date === selectedDate.value);
                    },
                    set(newValue) {
                         // ç•¶ draggable æ”¹è®Šé †åºæ™‚ï¼Œæ›´æ–°åŸæ•¸æ“š
                         let newItinerary = itinerary.value.filter(item => item.date !== selectedDate.value); 
                         newItinerary.push(...newValue); 
                         
                         // é‡æ–°æ’åºæ•´å€‹åˆ—è¡¨ä»¥ç¢ºä¿ä¸€è‡´æ€§ (é€™è£¡çš„ id æ’åºåªæ˜¯ç‚ºäº†ç©©å®šæ€§ï¼Œä¸å½±éŸ¿ç•«é¢)
                         itinerary.value = newItinerary.sort((a, b) => new Date(a.date) - new Date(b.date) || a.id - b.id);
                    }
                });

                const totalTWDExpenses = computed(() => {
                    return expenses.value.reduce((sum, item) => sum + item.amount, 0);
                });

                const modalTitle = computed(() => {
                    if (modalMode.value === 'add') {
                        if (modalContext.value === 'itinerary') return 'æ–°å¢è¡Œç¨‹';
                        if (modalContext.value === 'shopping') return 'æ–°å¢è³¼ç‰©æ¸…å–®é …ç›®';
                        if (modalContext.value === 'expenses') return 'æ–°å¢èŠ±è²»ç´€éŒ„';
                    }
                    if (modalMode.value === 'edit') {
                        return 'ç·¨è¼¯é …ç›® (å«åˆªé™¤)';
                    }
                    return 'æ“ä½œè¦–çª—';
                });

                // --- å‡½æ•¸ (Methods) ---
                
                const getCategoryColor = (type) => {
                    return CATEGORY_MAP[type]?.color || CATEGORY_MAP.other.color;
                }
                const getCategoryLabel = (type) => {
                    return CATEGORY_MAP[type]?.label || CATEGORY_MAP.other.label;
                }
                
                const transportationIcon = (type) => {
                    switch (type) {
                        case 'æ­¥è¡Œ': return 'ğŸš¶';
                        case 'é–‹è»Š': return 'ğŸš—';
                        case 'å¤§çœ¾é‹è¼¸': return 'ğŸšŒ';
                        default: return 'ğŸ“';
                    }
                }

                const openGoogleMaps = (locationName) => {
                    const encodedName = encodeURIComponent(locationName);
                    const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodedName}`;
                    window.open(mapUrl, '_blank');
                }

                const openAddModal = (context, mode = 'add') => { 
                    modalContext.value = context;
                    modalMode.value = mode;
                    isModalOpen.value = true;
                }
                const editItem = (item) => { 
                    modalContext.value = item.type; 
                    modalMode.value = 'edit';
                    isModalOpen.value = true; 
                }

                const confirmDelete = () => {
                    if (confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤é …ç›®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ’¤éŠ·ï¼')) {
                        alert('é …ç›®å·²åˆªé™¤ (æ¨¡æ“¬)');
                        isModalOpen.value = false;
                    }
                }
                
                const deleteItem = (id, context) => {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ')) {
                        if (context === 'shopping') {
                            shoppingList.value = shoppingList.value.filter(item => item.id !== id);
                        }
                        if (context === 'expenses') {
                             expenses.value = expenses.value.filter(item => item.id !== id);
                        }
                    }
                }

                return {
                    activeTab,
                    selectedDate,
                    isModalOpen,
                    modalContext,
                    modalMode,
                    modalTitle,
                    days,
                    filteredItinerary,
                    shoppingList,
                    expenses,
                    totalTWDExpenses, 
                    exchangeRate,
                    jpyAmount,
                    twdAmount,
                    weather,
                    flightInfo,
                    accommodation,
                    transportationIcon,
                    openGoogleMaps,
                    openAddModal,
                    editItem,
                    confirmDelete,
                    deleteItem,
                    getCategoryColor, 
                    getCategoryLabel
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
